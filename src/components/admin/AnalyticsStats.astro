---
import { getDB } from "../../utils/db";

const db = getDB(Astro);
let stats = {
    totalViews: 0,
    uniqueVisitors: 0,
    topPages: [],
    topSources: [],
    deviceTypes: [],
};

if (db) {
    try {
        // Total Views (30 days)
        const viewsResult = await db
            .prepare(
                `
      SELECT COUNT(*) as count FROM AnalyticsEvents 
      WHERE type = 'pageview' 
      AND timestamp >= datetime('now', '-30 days')
    `,
            )
            .first();
        stats.totalViews = (viewsResult as any)?.count || 0;

        // Unique Visitors (30 days)
        const visitorsResult = await db
            .prepare(
                `
      SELECT COUNT(DISTINCT session_hash) as count FROM AnalyticsEvents 
      WHERE timestamp >= datetime('now', '-30 days')
    `,
            )
            .first();
        stats.uniqueVisitors = (visitorsResult as any)?.count || 0;

        // Top Pages
        const pagesResult = await db
            .prepare(
                `
      SELECT path, COUNT(*) as count FROM AnalyticsEvents 
      WHERE type = 'pageview' 
      GROUP BY path 
      ORDER BY count DESC 
      LIMIT 5
    `,
            )
            .all();
        stats.topPages = pagesResult?.results || [];

        // Top Sources (UTM Source)
        const sourcesResult = await db
            .prepare(
                `
      SELECT utm_source, COUNT(*) as count FROM AnalyticsEvents 
      WHERE type = 'pageview' AND utm_source IS NOT NULL
      GROUP BY utm_source 
      ORDER BY count DESC 
      LIMIT 5
    `,
            )
            .all();
        stats.topSources = sourcesResult?.results || [];

        // Device Types
        const deviceResult = await db
            .prepare(
                `
      SELECT device_type, COUNT(*) as count FROM AnalyticsEvents 
      GROUP BY device_type
    `,
            )
            .all();
        stats.deviceTypes = deviceResult?.results || [];
    } catch (e) {
        console.error("Analytics Query Error:", e);
    }
}
---

<div class="space-y-6">
    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div
                class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2"
            >
                Total Views (30d)
            </div>
            <div class="text-3xl font-bold text-gray-900">
                {stats.totalViews}
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div
                class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2"
            >
                Unique Visitors (30d)
            </div>
            <div class="text-3xl font-bold text-indigo-600">
                {stats.uniqueVisitors}
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div
                class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2"
            >
                System Status
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse">
                </div>
                <span class="text-sm font-medium text-gray-700"
                    >Operational</span
                >
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Top Pages -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="font-bold text-gray-900 mb-4">Top Pages</h3>
            <div class="space-y-3">
                {
                    stats.topPages.length === 0 && (
                        <p class="text-gray-500 text-sm">No data yet.</p>
                    )
                }
                {
                    stats.topPages.map((page: any, index: number) => (
                        <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg transition-colors">
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-mono text-gray-400 w-6">
                                    #{index + 1}
                                </span>
                                <span class="text-sm text-gray-700 font-medium truncate max-w-[200px]">
                                    {page.path}
                                </span>
                            </div>
                            <span class="text-sm font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">
                                {page.count}
                            </span>
                        </div>
                    ))
                }
            </div>
        </div>

        <!-- Right Column: Top Sources & Devices -->
        <div class="space-y-6">
            <!-- Top Sources -->
            <div
                class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
            >
                <h3 class="font-bold text-gray-900 mb-4">Top Sources</h3>
                <div class="space-y-3">
                    {
                        stats.topSources.length === 0 && (
                            <p class="text-gray-500 text-sm">No data yet.</p>
                        )
                    }
                    {
                        stats.topSources.map((source: any) => (
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-700 capitalize">
                                    {source.utm_source}
                                </span>
                                <span class="text-sm text-gray-500">
                                    {source.count}
                                </span>
                            </div>
                        ))
                    }
                </div>
            </div>

            <!-- Device Breakdown -->
            <div
                class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
            >
                <h3 class="font-bold text-gray-900 mb-4">Device Types</h3>
                <div class="flex gap-4">
                    {
                        stats.deviceTypes.length === 0 && (
                            <p class="text-gray-500 text-sm">No data yet.</p>
                        )
                    }
                    {
                        stats.deviceTypes.map((device: any) => (
                            <div class="text-center">
                                <div class="text-lg font-bold text-gray-900">
                                    {device.count}
                                </div>
                                <div class="text-xs text-gray-500 uppercase tracking-wider">
                                    {device.device_type}
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</div>
