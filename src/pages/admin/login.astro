---
import Layout from "../../layouts/BaseLayout.astro";
---

<Layout title="Admin Login">
    <div class="min-h-screen flex items-center justify-center bg-gray-50 px-4">
        <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-900">Admin Access</h1>
                <p class="text-gray-600 mt-2">
                    Sign in to manage your dashboard
                </p>
            </div>

            <div id="step-email" class="space-y-6">
                <div>
                    <label
                        for="email"
                        class="block text-sm font-medium text-gray-700"
                        >Email address</label
                    >
                    <input
                        type="email"
                        id="email"
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                        placeholder="you@company.com"
                    />
                </div>
                <button
                    id="btn-send"
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                    Send Login Code
                </button>
            </div>

            <div id="step-verify" class="hidden space-y-6">
                <div>
                    <label
                        for="code"
                        class="block text-sm font-medium text-gray-700"
                        >Verification Code</label
                    >
                    <input
                        type="text"
                        id="code"
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 text-center text-2xl tracking-widest"
                        placeholder="123456"
                        maxlength="6"
                    />
                </div>
                <button
                    id="btn-verify"
                    class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 transition-colors"
                >
                    Verify & Login
                </button>
                <button
                    id="btn-back"
                    class="w-full text-sm text-gray-500 hover:text-gray-700"
                >
                    Use a different email
                </button>
            </div>

            <div id="message" class="mt-4 text-center text-sm hidden"></div>
        </div>
    </div>
</Layout>

<script>
    const stepEmail = document.getElementById("step-email");
    const stepVerify = document.getElementById("step-verify");
    const emailInput = document.getElementById("email") as HTMLInputElement;
    const codeInput = document.getElementById("code") as HTMLInputElement;
    const btnSend = document.getElementById("btn-send") as HTMLButtonElement;
    const btnVerify = document.getElementById(
        "btn-verify",
    ) as HTMLButtonElement;
    const btnBack = document.getElementById("btn-back") as HTMLButtonElement;
    const messageEl = document.getElementById("message");

    let currentEmail = "";

    function showMessage(text: string, type: "error" | "success") {
        if (!messageEl) return;
        messageEl.textContent = text;
        messageEl.className = `mt-4 text-center text-sm ${type === "error" ? "text-red-600" : "text-green-600"}`;
        messageEl.classList.remove("hidden");
    }

    btnSend?.addEventListener("click", async () => {
        const email = emailInput.value;
        if (!email) return showMessage("Please enter your email", "error");

        btnSend.disabled = true;
        btnSend.textContent = "Sending...";
        showMessage("", "success"); // clear

        try {
            const res = await fetch("/api/auth/send-code", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email }),
            });

            if (!res.ok) throw new Error("Failed to send code");

            currentEmail = email;
            stepEmail?.classList.add("hidden");
            stepVerify?.classList.remove("hidden");
            showMessage("Code sent! Check your inbox.", "success");
            codeInput?.focus();
        } catch (err) {
            showMessage("Something went wrong. Please try again.", "error");
        } finally {
            btnSend.disabled = false;
            btnSend.textContent = "Send Login Code";
        }
    });

    btnVerify?.addEventListener("click", async () => {
        const code = codeInput.value;
        if (!code) return showMessage("Please enter the code", "error");

        btnVerify.disabled = true;
        btnVerify.textContent = "Verifying...";

        try {
            const res = await fetch("/api/auth/verify-code", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: currentEmail, code }),
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.error || "Invalid code");
            }

            showMessage("Login successful! Redirecting...", "success");
            window.location.href = "/admin";
        } catch (err: any) {
            showMessage(err.message, "error");
            btnVerify.disabled = false;
            btnVerify.textContent = "Verify & Login";
        }
    });

    btnBack?.addEventListener("click", () => {
        stepVerify?.classList.add("hidden");
        stepEmail?.classList.remove("hidden");
        messageEl?.classList.add("hidden");
    });
</script>
