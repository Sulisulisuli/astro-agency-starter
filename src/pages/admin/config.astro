---
export const prerender = false;
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getDB } from '../../utils/db';
import { actions } from 'astro:actions';

const db = getDB(Astro);
let configs: any[] = [];
if (db) {
    const result = await db.prepare('SELECT key, value FROM SiteConfig').all();
    configs = (result.results || []).map((c: any) => ({
        ...c,
        value: typeof c.value === 'string' ? JSON.parse(c.value) : c.value
    }));
}
const result = Astro.getActionResult(actions.config.update);
---

<AdminLayout title="Configuration Editor">
  {result && !result.error && (
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4" role="alert">
      <strong class="font-bold">Success!</strong>
      <span class="block sm:inline"> Configuration updated.</span>
    </div>
  )}
  {result?.error && (
     <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">
       <strong class="font-bold">Error!</strong>
       <span class="block sm:inline"> {result.error.message}</span>
     </div>
   )}

  <div class="space-y-8">
    {configs.map(conf => (
      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <div class="flex justify-between items-start mb-4">
            <h3 class="font-bold text-lg text-gray-900 font-mono bg-gray-100 px-2 py-1 rounded">{conf.key}</h3>
            <span class="text-xs text-gray-500">JSON / Text</span>
        </div>
        
        <form method="POST" action={actions.config.update}>
          <input type="hidden" name="key" value={conf.key} />
          <div class="mb-4">
            <textarea 
              name="value" 
              rows="6" 
              class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 font-mono text-sm bg-slate-50 p-3"
            >{JSON.stringify(conf.value, null, 2)}</textarea>
            <p class="text-xs text-gray-500 mt-1">Edit the JSON value above directly.</p>
          </div>
          <div class="flex justify-end">
            <button 
                type="submit" 
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
                Save Changes
            </button>
          </div>
        </form>
      </div>
    ))}
  </div>
</AdminLayout>
