---
export const prerender = false;
import AdminLayout from "../../layouts/AdminLayout.astro";
import { getDB } from "../../utils/db";
import { actions } from "astro:actions";

const db = getDB(Astro);
let configs: any[] = [];
if (db) {
  const result = await db.prepare("SELECT key, value FROM SiteConfig").all();
  configs = (result.results || []).map((c: any) => ({
    ...c,
    value: typeof c.value === "string" ? JSON.parse(c.value) : c.value,
  }));
}
const result = Astro.getActionResult(actions.config.update);
---

<AdminLayout title="Configuration Editor">
  {
    result && !result.error && (
      <div
        class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"
        role="alert"
      >
        <strong class="font-bold">Success!</strong>
        <span class="block sm:inline"> Configuration updated.</span>
      </div>
    )
  }
  {
    result?.error && (
      <div
        class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
        role="alert"
      >
        <strong class="font-bold">Error!</strong>
        <span class="block sm:inline"> {result.error.message}</span>
      </div>
    )
  }

  <div class="space-y-8">
    {
      configs.map((conf) => (
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <div class="flex justify-between items-start mb-4">
            <h3 class="font-bold text-lg text-gray-900 font-mono bg-gray-100 px-2 py-1 rounded">
              {conf.key}
            </h3>
            <span class="text-xs text-gray-500">JSON / Text</span>
          </div>

          <form method="POST" action={actions.config.update}>
            <input type="hidden" name="key" value={conf.key} />

            <div class="space-y-6">
              {conf.key === "scripts" ? (
                <div class="space-y-6">
                  <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <div class="flex">
                      <div class="flex-shrink-0">
                        <svg
                          class="h-5 w-5 text-yellow-400"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd"
                          />
                        </svg>
                      </div>
                      <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                          Advanced: These scripts will be injected into every
                          page. Be careful with syntax errors.
                        </p>
                      </div>
                    </div>
                  </div>
                  {typeof conf.value === "object" &&
                    conf.value !== null &&
                    Object.entries(conf.value).map(([subKey, subValue]) => (
                      <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
                          {subKey === "head"
                            ? "HEAD CODE (GOOGLE ANALYTICS, GTM, PIXEL)"
                            : "FOOTER CODE (CHAT WIDGETS, TRACKERS)"}
                        </label>
                        <textarea
                          rows="6"
                          data-config-key={conf.key}
                          data-json-key={subKey}
                          class="block w-full bg-gray-900 border-gray-700 focus:border-indigo-500 focus:ring-0 rounded-lg px-4 py-3 text-green-400 font-mono shadow-sm transition-colors text-sm"
                          placeholder={
                            subKey === "head"
                              ? "<!-- Paste Google Analytics / GTM here -->"
                              : "<!-- Paste Chat widgets here -->"
                          }
                        >
                          {String(subValue).trim()}
                        </textarea>
                        <p class="mt-1 text-xs text-gray-400">
                          Inserted{" "}
                          {subKey === "head"
                            ? "before </head>"
                            : "before </body>"}
                        </p>
                      </div>
                    ))}
                </div>
              ) : typeof conf.value === "object" && conf.value !== null ? (
                Object.entries(conf.value).map(([subKey, subValue]) => (
                  <div class="group">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
                      {subKey.replace(/_/g, " ")}
                    </label>
                    <div>
                      {/* Interactive Input Generation */}
                      {typeof subValue === "string" &&
                      subValue.startsWith("#") &&
                      subValue.length <= 7 ? (
                        <div class="flex items-center gap-3">
                          <div class="relative">
                            <input
                              type="color"
                              value={subValue as string}
                              data-config-key={conf.key}
                              data-json-key={subKey}
                              class="h-12 w-12 block bg-white border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer p-1"
                            />
                          </div>
                          <input
                            type="text"
                            value={subValue as string}
                            data-config-key={conf.key}
                            data-json-key={subKey}
                            class="flex-1 block w-full bg-gray-50 border-transparent focus:border-indigo-500 focus:bg-white focus:ring-0 rounded-lg px-4 py-3 text-gray-900 shadow-sm transition-colors text-sm font-medium"
                          />
                        </div>
                      ) : (
                        <textarea
                          rows="2"
                          data-config-key={conf.key}
                          data-json-key={subKey}
                          class="block w-full bg-gray-50 border-transparent focus:border-indigo-500 focus:bg-white focus:ring-0 rounded-lg px-4 py-3 text-gray-900 shadow-sm transition-colors text-sm resize-y"
                        >
                          {String(subValue).trim()}
                        </textarea>
                      )}
                    </div>
                  </div>
                ))
              ) : (
                /* Fallback for simple string values that aren't JSON objects */
                <input
                  type="text"
                  value={conf.value}
                  name="value"
                  class="block w-full bg-gray-50 border-transparent focus:border-indigo-500 focus:bg-white focus:ring-0 rounded-lg px-4 py-3 text-gray-900 shadow-sm transition-colors"
                />
              )}
            </div>

            {/* Hidden input to store the final stringified JSON */}
            {typeof conf.value === "object" && (
              <input
                type="hidden"
                name="value"
                id={`hidden-input-${conf.key}`}
                value={JSON.stringify(conf.value)}
              />
            )}

            <div class="flex justify-end mt-4">
              <button
                type="submit"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                Save Changes
              </button>
            </div>
          </form>
        </div>
      ))
    }
  </div>

  <script define:vars={{ initialConfigs: configs }}>
    // Fix textarea whitespace on load (handling potential HTML formatting artifacts)
    function trimTextareas() {
      document.querySelectorAll("textarea").forEach((el) => {
        el.value = el.value.trim();
      });
    }

    // Run on load and after Astro swaps (if view transitions are used)
    document.addEventListener("DOMContentLoaded", trimTextareas);
    document.addEventListener("astro:page-load", trimTextareas);

    // Simple reactivity for JSON construction
    // We listen to changes on inputs with data-config-key and data-json-key
    document.addEventListener("input", (e) => {
      const target = e.target;
      if (!target.hasAttribute("data-config-key")) return;

      const configKey = target.getAttribute("data-config-key");
      const jsonKey = target.getAttribute("data-json-key");
      const newValue = target.value;

      // Find the hidden input
      const hiddenInput = document.getElementById(`hidden-input-${configKey}`);
      if (!hiddenInput) return;

      // Sync dual inputs (e.g. Color Picker + Text)
      if (
        target.type === "color" ||
        (target.type === "text" && target.value.startsWith("#"))
      ) {
        const sibling = target.parentElement.querySelector(
          `input:not([type="${target.type}"])`,
        );
        if (sibling) sibling.value = newValue;
      }

      try {
        const currentObj = JSON.parse(hiddenInput.value);
        currentObj[jsonKey] = newValue;
        hiddenInput.value = JSON.stringify(currentObj);
      } catch (err) {
        console.error("Error updating JSON config", err);
      }
    });
  </script>
</AdminLayout>
