---
export const prerender = false;
import { getDB } from '../utils/db';

let status = "Initializing...";
let error = null;
let data = null;
let envCheck: Record<string, any> = {};

try {
  const db = getDB(Astro);
  
  if (!db) {
    throw new Error("D1 database binding 'DB' not available in Astro.locals.runtime.env");
  }

  status = "D1 Binding found. Attempting query...";
  
  // Try a simple select
  const result = await db.prepare('SELECT key, value FROM SiteConfig LIMIT 1').all();
  data = result.results || [];
  status = "Success! D1 connected.";
} catch (e: any) {
  status = "Failed";
  error = e.message || JSON.stringify(e);
  console.error("Debug Page Error:", e);
}

// Check runtime env
try {
   // @ts-ignore
   envCheck.hasRuntime = !!Astro.locals?.runtime;
   // @ts-ignore
   envCheck.hasEnv = !!Astro.locals?.runtime?.env;
   // @ts-ignore
   envCheck.hasDB = !!Astro.locals?.runtime?.env?.DB;
   envCheck.SSR = import.meta.env.SSR;
} catch (e) {
    // ignore
}
---

<html>
<head><title>Debug Page - D1 Direct</title></head>
<body style="font-family: monospace; padding: 2rem; background: #222; color: #0f0;">
  <h1>D1 Diagnostics</h1>
  <hr style="border-color: #444"/>
  
  <p><strong>Status:</strong> {status}</p>
  
  {error && (
     <div style="background: #500; color: white; padding: 1rem; margin: 1rem 0;">
       <strong>Error:</strong> {error}
     </div>
  )}

  {data && (
    <div>
      <h3>Data Sample:</h3>
      <pre>{JSON.stringify(data, null, 2)}</pre>
    </div>
  )}

  <h3>Environment Check:</h3>
  <pre>{JSON.stringify(envCheck, null, 2)}</pre>
  
  <p>If you see this page, the Cloudflare Worker is running.</p>
</body>
</html>
